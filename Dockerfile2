FROM php:8.1.2-fpm

# Arguments defined in docker-compose.yml
ARG user
ARG uid




# Install system dependencies
RUN apt-get update && apt-get install -y \
    git \
    curl \
    libpng-dev \
    libonig-dev \
    libxml2-dev \
    zip \
    unzip \
    nano \
    default-mysql-client



# Clear cache
RUN apt-get clean && rm -rf /var/lib/apt/lists/*

# Install PHP extensions
RUN docker-php-ext-install pdo_mysql mbstring exif pcntl bcmath gd

RUN pecl install -o -f redis &&  rm -rf /tmp/pear &&  docker-php-ext-enable redis


# Get latest Composer
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer




# install nodejs
RUN curl --silent --location https://deb.nodesource.com/setup_16.x | bash -
RUN apt-get install -y \
  nodejs
RUN echo "Node: " && node -v
RUN echo "NPM: " && npm -v


# Set working directory
WORKDIR /var/www

COPY . .


RUN rm -rf ./vendor
RUN rm -rf ./composer.lock

RUN composer install

RUN npm install

RUN npm run build



COPY .env.docker /var/www/.env

RUN php artisan cache:clear

USER $user

# CRA


